name: Build WSA (Matrix Auto Build)

on:
  workflow_dispatch:  
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        windows: [10, 11]
        gapps: [none, mindthegapps]
        arch: [x64]
        include:
          - windows: 10
            release_type: retail
          - windows: 11
            release_type: retail

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "==== Setting up environment ===="
          sudo apt update -y
          sudo apt install -y git wget unzip python3 python3-pip p7zip-full aria2 jq

      - name: Clone MagiskOnWSALocal
        run: |
          echo "==== Cloning MagiskOnWSALocal ===="
          git clone https://github.com/LSPosed/MagiskOnWSALocal.git --depth=1
          cd MagiskOnWSALocal

      - name: Build WSA
        working-directory: MagiskOnWSALocal
        run: |
          echo "==== Building WSA ===="
          python3 -m venv .venv
          source .venv/bin/activate

          ARCH="${{ matrix.arch }}"
          RELEASE_TYPE="${{ matrix.release_type }}"
          WINVER="${{ matrix.windows }}"
          GAPPSTYPE="${{ matrix.gapps }}"

          echo "Architecture: $ARCH"
          echo "Release type: $RELEASE_TYPE"
          echo "GApps variant: $GAPPSTYPE"
          echo "Target Windows version: $WINVER"

          bash ./build.sh \
            --arch "$ARCH" \
            --release-type "$RELEASE_TYPE" \
            --magisk-ver stable \
            --root-sol none \
            --compress-format 7z \
            $( [ "$GAPPSTYPE" != "none" ] && echo "--gapps-variant $GAPPSTYPE" )

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: MagiskOnWSALocal/output/*.7z
          tag_name: "auto-build-${{ matrix.windows }}-${{ matrix.gapps }}"
          name: "WSA_${{ matrix.windows }}_${{ matrix.gapps }}_x64"
          body: |
            üèóÔ∏è Auto-built WSA package
            - Windows version: ${{ matrix.windows }}
            - GApps: ${{ matrix.gapps }}
            - Architecture: ${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
