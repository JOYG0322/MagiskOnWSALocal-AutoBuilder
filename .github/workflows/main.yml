name: Build WSA (Magisk + GApps)

on:
  workflow_dispatch:
    inputs:
      MagiskVersion:
        description: 'Magisk version'
        required: false
        default: '27.0'
      RootSolution:
        description: 'Root solution (Magisk / KernelSU / None)'
        required: false
        default: 'Magisk'
      GApps:
        description: 'GApps variant (MindTheGapps / OpenGApps / None)'
        required: false
        default: 'MindTheGapps'
      RemoveAmazon:
        description: 'Remove Amazon Appstore'
        required: false
        default: 'true'
      Architecture:
        description: 'Architecture (x64 / arm64)'
        required: false
        default: 'x64'
      WindowsEdition:
        description: 'Target Windows edition (10 / 11)'
        required: false
        default: '10'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive     
          fetch-depth: 0            

      - name: Prepare environment
        run: |
          sudo apt update
          sudo apt install -y git wget unzip python3 python3-pip p7zip-full aria2
          chmod +x scripts/run.sh

      - name: Build WSA
        run: |
          echo "==== Building WSA ===="
          bash scripts/run.sh \
            --magisk ${{ github.event.inputs.MagiskVersion }} \
            --root ${{ github.event.inputs.RootSolution }} \
            --gapps ${{ github.event.inputs.GApps }} \
            --removeamazon ${{ github.event.inputs.RemoveAmazon }} \
            --arch ${{ github.event.inputs.Architecture }} \
            --windows ${{ github.event.inputs.WindowsEdition }}

      - name: Rename output with timestamp
        if: success()
        run: |
          mkdir -p renamed_output
          for f in output/*.7z; do
            newname="WSA_${{ github.event.inputs.RootSolution }}_${{ github.event.inputs.MagiskVersion }}_${{ github.event.inputs.Architecture }}_${{ github.event.inputs.WindowsEdition }}_$(date +'%Y%m%d').7z"
            mv "$f" "renamed_output/$newname"
          done

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-${{ github.run_id }}
          path: renamed_output/*.7z
