name: Build WSA (Full Auto)

on:
  workflow_dispatch:
    inputs:
      magisk_version:
        description: "Magisk version"
        required: true
        default: "stable"
      root_solution:
        description: "Root solution (magisk/kernelsu/none)"
        required: true
        default: "none"
      gapps_variant:
        description: "GApps variant (MindTheGapps/OpenGApps/none)"
        required: true
        default: "none"
      architecture:
        description: "Architecture (x64/arm64)"
        required: true
        default: "x64"
      windows_edition:
        description: "Target Windows edition (10/11)"
        required: true
        default: "11"

env:
  TERM: xterm
  DEBIAN_FRONTEND: noninteractive
  PIP_DISABLE_PIP_VERSION_CHECK: 1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Prepare build environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip git wget unzip p7zip-full jq
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          echo "Environment ready."

      - name: üß± Run build script
        run: |
          chmod +x ./build.sh
          echo "==== Building WSA ===="
          ./build.sh \
            --arch "${{ github.event.inputs.architecture }}" \
            --release-type retail \
            --magisk-ver "${{ github.event.inputs.magisk_version }}" \
            --root-sol "${{ github.event.inputs.root_solution }}" \
            --gapps-type "${{ github.event.inputs.gapps_variant }}" \
            --compress-format 7z || (cat build.log || true)
        shell: bash

      - name: üì¶ Collect output
        run: |
          mkdir -p output
          find . -maxdepth 2 -type f \( -name "*.7z" -o -name "*.zip" \) -exec mv {} ./output/ \;
          ls -lh output || echo "No output files found."

      - name: üöÄ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WSA-${{ github.event.inputs.windows_edition }}-${{ github.event.inputs.architecture }}
          path: output/

      - name: ü™Ñ Publish to GitHub Releases
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "wsa-${{ github.run_id }}"
          name: "WSA Build - ${{ github.event.inputs.windows_edition }} - ${{ github.event.inputs.architecture }}"
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
