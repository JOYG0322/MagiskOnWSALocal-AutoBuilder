name: Sync Upstream

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # ÊØèÂ§© UTC 12 ÁÇπËá™Âä®ÂêåÊ≠•ÔºàÂèØÊîπÔºâ

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      UPSTREAM_REPO: LSPosed/MagiskOnWSALocal
      UPSTREAM_BRANCH: main
      PROTECTED_FILES: |
        .github/workflows/build-wsa.yml
        .github/workflows/sync-upstream.yml
        docs/README.md
        docs/README_zh.md

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Backup protected files
        run: |
          mkdir -p ../backup
          for file in $PROTECTED_FILES; do
            if [ -f "$file" ]; then
              mkdir -p "../backup/$(dirname $file)"
              cp "$file" "../backup/$file"
            fi
          done

      - name: Merge upstream changes
        run: |
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit || true

      - name: Restore protected files
        run: |
          for file in $PROTECTED_FILES; do
            if [ -f "../backup/$file" ]; then
              cp "../backup/$file" "$file"
            fi
          done

      - name: Commit and push changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "üîÑ Sync with upstream ${{ env.UPSTREAM_REPO }}"
            git push origin HEAD
          else
            echo "No changes to commit."
          fi
