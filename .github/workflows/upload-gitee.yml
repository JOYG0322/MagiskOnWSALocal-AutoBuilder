name: Upload to Gitee Releases

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
  workflow_run:
    workflows: ["Build & Release WSA Variants"]
    types:
      - completed

permissions:
  contents: read

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup dependencies
        run: sudo apt-get install -y curl jq git

      - name: Generate tag name
        id: tag
        run: echo "TAG_NAME=build-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: Download all release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release
          echo "üì¶ Downloading all release artifacts..."
          gh release download --repo "${{ github.repository }}" --pattern "*.7z" --dir release

      - name: Upload each .7z to Gitee
        env:
          GITEE_USER: JOYG0322
          GITEE_REPO: magisk-on-wsalocal-auto-builder
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: ${{ env.TAG_NAME }}
        run: |
          chmod +x scripts/upload-gitee.sh
          for file in release/*.7z; do
            if [ -f "$file" ]; then
              echo "üÜô Uploading $file..."
              bash scripts/upload-gitee.sh "$GITEE_USER" "$GITEE_REPO" "$TAG_NAME" "$file"
            else
              echo "‚ö†Ô∏è No .7z file found!"
              exit 1
            fi
          done
