name: Upload Built WSA Packages to Gitee

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  upload-gitee:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { winver: 10, root: magisk, gapps: none }
          - { winver: 10, root: magisk, gapps: mindthegapps }
          - { winver: 10, root: kernelsu, gapps: none }
          - { winver: 10, root: none, gapps: mindthegapps }
          - { winver: 11, root: magisk, gapps: none }
          - { winver: 11, root: magisk, gapps: mindthegapps }
          - { winver: 11, root: kernelsu, gapps: none }
          - { winver: 11, root: none, gapps: mindthegapps }

    env:
      GH_TOKEN: ${{ github.token }}   # ‚úÖ ÂøÖÈ°ªÊ∑ªÂä†Ôºå‰æõ gh CLI ‰ΩøÁî®

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate tag name
        id: set_tag
        run: |
          TAG_NAME="build-$(date +'%Y%m%d-%H%M%S')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Generated tag: $TAG_NAME"

      - name: Prepare release files
        run: |
          mkdir -p release
          echo "üì¶ Fetching built artifact for: ${{ matrix.winver }} / ${{ matrix.root }} / ${{ matrix.gapps }}"

          # Ëá™Âä®ÈáçËØï 3 Ê¨°ÔºåÈÅøÂÖçÂÅ∂Âèë‰∏ãËΩΩÂ§±Ë¥•
          for i in 1 2 3; do
            gh release download --repo "${{ github.repository }}" \
              --pattern "WSA_${{ matrix.winver }}_${{ matrix.root }}_${{ matrix.gapps }}.7z" \
              --dir release && break
            echo "‚ö†Ô∏è Download attempt $i failed, retrying in 5s..."
            sleep 5
          done

          FILE_PATH=$(find release -name "*.7z" | head -n 1)
          if [ ! -f "$FILE_PATH" ]; then
            echo "‚ùå No .7z found for ${{ matrix.winver }} ${{ matrix.root }} ${{ matrix.gapps }}"
            exit 1
          fi
          echo "‚úÖ Found file: $FILE_PATH"

      - name: Upload to Gitee Releases
        env:
          GITEE_USER: JOYG0322
          GITEE_REPO: magisk-on-wsalocal-auto-builder
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: ${{ env.TAG_NAME }}
        run: |
          chmod +x scripts/upload-gitee.sh
          FILE_PATH=$(find release -name "*.7z" | head -n 1)
          echo "üÜô Uploading $FILE_PATH to Gitee as tag $TAG_NAME"
          bash scripts/upload-gitee.sh "$GITEE_USER" "$GITEE_REPO" "$TAG_NAME" "$FILE_PATH"
