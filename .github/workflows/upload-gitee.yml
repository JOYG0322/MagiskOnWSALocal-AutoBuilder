#!/usr/bin/env bash
set -e

GITEE_USER="$1"
GITEE_REPO="$2"
TAG_NAME="$3"
FILE_PATH="$4"

if [ -z "$GITEE_TOKEN" ]; then
  echo "âŒ ç¼ºå°‘ GITEE_TOKEN ç¯å¢ƒå˜é‡"
  exit 1
fi

if [ ! -f "$FILE_PATH" ]; then
  echo "âŒ æœªæ‰¾åˆ°æ–‡ä»¶: $FILE_PATH"
  exit 1
fi

FILE_NAME=$(basename "$FILE_PATH")
API_BASE="https://gitee.com/api/v5/repos/${GITEE_USER}/${GITEE_REPO}"

echo "ğŸ“¦ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: $FILE_NAME"
echo "â¡ï¸ ç›®æ ‡ä»“åº“: ${GITEE_USER}/${GITEE_REPO}"
echo "â¡ï¸ æ ‡ç­¾: ${TAG_NAME}"

# æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥ release
echo "ğŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å­˜åœ¨..."
EXISTING_RELEASE=$(curl -s -H "Authorization: token ${GITEE_TOKEN}" \
  "${API_BASE}/releases/tags/${TAG_NAME}" || true)

# è·å–å½“å‰æäº¤ SHA
COMMIT_SHA=$(git rev-parse HEAD)
if [ -z "$COMMIT_SHA" ]; then
  COMMIT_SHA="main"
fi

if echo "$EXISTING_RELEASE" | grep -q "\"tag_name\":\"${TAG_NAME}\""; then
  echo "ğŸ” Release å·²å­˜åœ¨ï¼Œå‡†å¤‡æ›´æ–°ä¸Šä¼ ..."
  RELEASE_ID=$(echo "$EXISTING_RELEASE" | grep -o '"id":[0-9]*' | head -n1 | cut -d: -f2)
else
  echo "ğŸ†• åˆ›å»ºæ–°çš„ Release..."
  CREATE_RESPONSE=$(curl -s -X POST "${API_BASE}/releases" \
    -H "Content-Type: application/json" \
    -H "Authorization: token ${GITEE_TOKEN}" \
    -d "{
      \"tag_name\": \"${TAG_NAME}\",
      \"name\": \"${TAG_NAME}\",
      \"body\": \"WSA Auto Build Release - ${TAG_NAME}\",
      \"target_commitish\": \"${COMMIT_SHA}\"
    }")

  if echo "$CREATE_RESPONSE" | grep -q "\"id\":"; then
    RELEASE_ID=$(echo "$CREATE_RESPONSE" | grep -o '"id":[0-9]*' | head -n1 | cut -d: -f2)
    echo "âœ… åˆ›å»ºæˆåŠŸï¼ŒRelease ID: $RELEASE_ID"
  else
    echo "âŒ åˆ›å»º Release å¤±è´¥ï¼å“åº”ï¼š$CREATE_RESPONSE"
    exit 1
  fi
fi

# ä¸Šä¼ æ–‡ä»¶åˆ° Release
echo "â¬†ï¸ ä¸Šä¼ æ–‡ä»¶åˆ° Gitee..."
UPLOAD_URL="${API_BASE}/releases/${RELEASE_ID}/assets?access_token=${GITEE_TOKEN}"
RESPONSE=$(curl -s -X POST \
  -F "file=@${FILE_PATH}" \
  -F "name=${FILE_NAME}" \
  "${UPLOAD_URL}")

if echo "$RESPONSE" | grep -q "\"id\":"; then
  echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${FILE_NAME}"
else
  echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼å“åº”ï¼š$RESPONSE"
  exit 1
fi

echo "ğŸ‰ ä¸Šä¼ å®Œæˆï¼"
