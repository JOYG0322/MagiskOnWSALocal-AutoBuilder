name: Upload to Gitee Releases

on:
  workflow_dispatch:
  workflow_call:

jobs:
  upload:
    name: Upload ${{ matrix.os_version }} / ${{ matrix.root_variant }} / ${{ matrix.gapps_variant }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        os_version: [10, 11]
        root_variant: [magisk, kernelsu, none]
        gapps_variant: [mindthegapps, none]
        exclude:
          - root_variant: none
            gapps_variant: none

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release
          ARTIFACT="WSA_${{ matrix.os_version }}_${{ matrix.root_variant }}_${{ matrix.gapps_variant }}"
          echo "üì¶ Fetching artifact: $ARTIFACT"
          gh run download --repo "${{ github.repository }}" --name "$ARTIFACT" --dir release || true
          if [ -z "$(find release -name '*.7z' 2>/dev/null)" ]; then
            echo "‚ùå No .7z found for $ARTIFACT"
            exit 1
          fi

      - name: Upload to Gitee Releases
        env:
          GITEE_USER: JOYG0322
          GITEE_REPO: magisk-on-wsalocal-auto-builder
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          TAG_NAME: build-${{ github.run_id }}
        run: |
          FILE_PATH=$(find release -name "*.7z" | head -n 1)
          echo "Found file: $FILE_PATH"
          chmod +x scripts/upload-gitee.sh
          bash scripts/upload-gitee.sh "$GITEE_USER" "$GITEE_REPO" "$TAG_NAME" "$FILE_PATH"
